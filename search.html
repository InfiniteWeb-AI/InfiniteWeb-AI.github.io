<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Explore Websites - InfiniteWeb</title>
  <meta name="description" content="Search and explore AI-generated websites by InfiniteWeb.">
  <link rel="icon" href="static/images/logo.jpg" type="image/jpeg">
  <link rel="stylesheet" href="static/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="static/css/index.css">
  <link rel="stylesheet" href="static/css/search.css">
</head>
<body class="search-page">

<!-- ========== SEARCH TOPBAR ========== -->
<nav class="search-topbar">
  <div class="container">
    <div class="search-topbar-inner">
      <a href="index.html" class="search-topbar-brand">
        <img src="static/images/logo.jpg" alt="InfiniteWeb" style="height:32px;width:32px;object-fit:cover;border-radius:6px;">
        <span>InfiniteWeb</span>
      </a>
      <div class="search-topbar-input-wrap">
        <span class="search-topbar-icon"><i class="fas fa-search"></i></span>
        <input class="search-topbar-input" type="text" id="searchInput"
               placeholder="Search website types..." aria-label="Search website types">
        <button class="search-topbar-clear" id="clearBtn" style="display:none;" aria-label="Clear search">&times;</button>
      </div>
      <a href="index.html" class="search-topbar-home">
        <i class="fas fa-home"></i> Home
      </a>
    </div>

    <!-- Filter Chips -->
    <div class="search-chips" id="filterChips">
      <span class="search-chip" data-tag="e-commerce">E-commerce</span>
      <span class="search-chip" data-tag="dashboard">Dashboard</span>
      <span class="search-chip" data-tag="blog">Blog</span>
      <span class="search-chip" data-tag="restaurant">Restaurant</span>
      <span class="search-chip" data-tag="travel">Travel</span>
      <span class="search-chip" data-tag="education">Education</span>
      <span class="search-chip" data-tag="task manager">Task Manager</span>
      <span class="search-chip" data-tag="portfolio">Portfolio</span>
      <span class="search-chip" data-tag="CRM">CRM</span>
      <span class="search-chip search-chip-clear" id="clearFilters" style="display:none;">
        <i class="fas fa-times"></i> Clear
      </span>
    </div>
  </div>
</nav>

<!-- ========== RESULTS ========== -->
<main class="search-results-area">
  <div class="container">
    <p class="search-result-count" id="resultCount"></p>

    <div class="columns is-multiline" id="resultsGrid">
      <!-- Cards rendered by JS -->
    </div>

    <div class="has-text-centered" id="emptyState" style="display:none;">
      <div class="search-empty">
        <i class="fas fa-search fa-3x"></i>
        <p class="mt-4 is-size-5">No matching websites found.</p>
        <p class="has-text-grey">Try a different search term or clear your filters.</p>
      </div>
    </div>

    <div class="has-text-centered" id="welcomeState" style="display:none;">
      <div class="search-empty">
        <i class="fas fa-globe fa-3x"></i>
        <p class="mt-4 is-size-5">Explore AI-generated websites</p>
        <p class="has-text-grey">Type a keyword or click a filter chip to get started.</p>
      </div>
    </div>
  </div>
</main>

<!-- Website Preview Modal -->
<div class="modal" id="previewModal">
  <div class="modal-background"></div>
  <div class="modal-content modal-preview-content">
    <div class="box modal-preview-box">
      <div class="modal-preview-header">
        <h3 class="title is-4" id="modalTitle">Website Title</h3>
        <p class="subtitle is-6 has-text-grey" id="modalDesc">Description</p>
        <div class="tags" id="modalTags"></div>
      </div>
      <div class="modal-preview-iframe-wrap">
        <iframe id="previewIframe" class="modal-preview-iframe" src="about:blank" title="Website preview"></iframe>
      </div>
      <div class="buttons is-centered mt-4">
        <a class="button is-primary" id="modalOpenBtn" href="#" target="_blank">
          <span class="icon"><i class="fas fa-external-link-alt"></i></span>
          <span>Open Full Page</span>
        </a>
        <button class="button is-warning" id="modalResetBtn">
          <span class="icon"><i class="fas fa-redo"></i></span>
          <span>Reset</span>
        </button>
      </div>
    </div>
  </div>
  <button class="modal-close is-large" aria-label="close"></button>
</div>

<!-- ========== FOOTER ========== -->
<footer class="footer">
  <div class="container has-text-centered">
    <p>
      <a href="index.html" class="footer-link">
        <span class="icon"><i class="fas fa-arrow-left"></i></span> Back to InfiniteWeb
      </a>
      &nbsp;&nbsp;
      <a href="https://arxiv.org/abs/2601.04126" target="_blank" class="footer-link">
        <span class="icon"><i class="fas fa-file-pdf"></i></span> Paper
      </a>
    </p>
  </div>
</footer>

<script>
/* ========== Search Page JavaScript ========== */

let galleryData = [];
let activeFilters = new Set();

document.addEventListener('DOMContentLoaded', async () => {
  // Load data
  try {
    const resp = await fetch('static/data/gallery.json');
    const data = await resp.json();
    galleryData = data.items || [];
  } catch (e) {
    console.warn('Could not load gallery data:', e);
  }

  initSearch();
  initChips();
  initModal();

  // Read URL params
  const params = new URLSearchParams(window.location.search);
  const q = params.get('q');
  const demoId = params.get('demo');

  const input = document.getElementById('searchInput');
  if (q) {
    input.value = q;
    document.getElementById('clearBtn').style.display = 'block';
    doSearch();
  } else {
    renderResults(galleryData);
  }

  if (demoId) {
    const item = galleryData.find(i => i.id === demoId);
    if (item) setTimeout(() => openPreview(item), 300);
  }
});

function initSearch() {
  const input = document.getElementById('searchInput');
  const clearBtn = document.getElementById('clearBtn');

  input.addEventListener('input', () => {
    clearBtn.style.display = input.value ? 'block' : 'none';
    doSearch();
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doSearch();
  });

  clearBtn.addEventListener('click', () => {
    input.value = '';
    clearBtn.style.display = 'none';
    doSearch();
  });
}

function initChips() {
  const chips = document.querySelectorAll('.search-chip:not(.search-chip-clear)');
  const clearBtn = document.getElementById('clearFilters');

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      const tag = chip.dataset.tag;
      if (activeFilters.has(tag)) {
        activeFilters.delete(tag);
        chip.classList.remove('is-active');
      } else {
        activeFilters.add(tag);
        chip.classList.add('is-active');
      }
      clearBtn.style.display = activeFilters.size > 0 ? 'inline-flex' : 'none';
      doSearch();
    });
  });

  clearBtn.addEventListener('click', () => {
    activeFilters.clear();
    chips.forEach(c => c.classList.remove('is-active'));
    clearBtn.style.display = 'none';
    doSearch();
  });
}

function doSearch() {
  const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
  const tokens = q ? q.split(/\s+/) : [];

  let filtered = galleryData;

  // Text search
  if (tokens.length > 0) {
    filtered = filtered.filter(item => {
      const searchable = [item.title, item.description, ...(item.tags || [])].join(' ').toLowerCase();
      return tokens.every(t => searchable.includes(t));
    });
  }

  // Tag filters
  if (activeFilters.size > 0) {
    filtered = filtered.filter(item => {
      const itemTags = (item.tags || []).map(t => t.toLowerCase());
      return [...activeFilters].some(f => itemTags.includes(f.toLowerCase()));
    });
  }

  renderResults(filtered);
}

function renderResults(items) {
  const grid = document.getElementById('resultsGrid');
  const empty = document.getElementById('emptyState');
  const welcome = document.getElementById('welcomeState');
  const count = document.getElementById('resultCount');

  if (welcome) welcome.style.display = 'none';

  count.textContent = `${items.length} website${items.length !== 1 ? 's' : ''} found`;

  if (items.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';

  grid.innerHTML = items.map((item, i) => {
    const px = 18 + (i * 11) % 70;
    const py = 14 + (i * 17) % 70;
    return `
      <div class="column is-3-desktop is-4-tablet is-6-mobile">
        <div class="website-card is-fallback" data-id="${item.id}" style="--px:${px}%;--py:${py}%;">
          <div class="website-card-thumb-wrap"></div>
          <div class="website-card-body">
            <div class="website-card-title">${item.title}</div>
            <div class="website-card-desc">${item.description}</div>
            <div class="website-card-tags">
              ${(item.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
            <div class="website-card-meta">
              <span><i class="fas fa-tasks"></i> ${item.taskCount || '?'} tasks</span>
              <span><i class="fas fa-file"></i> ${item.pageCount || '?'} pages</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // Click handlers
  grid.querySelectorAll('.website-card').forEach(card => {
    card.addEventListener('click', () => {
      const id = card.dataset.id;
      const item = galleryData.find(i => i.id === id);
      if (item) openPreview(item);
    });
  });
}

/* ---- Modal ---- */
function initModal() {
  const modal = document.getElementById('previewModal');
  if (!modal) return;

  modal.querySelector('.modal-background').addEventListener('click', closePreview);
  modal.querySelector('.modal-close').addEventListener('click', closePreview);

  document.getElementById('modalResetBtn').addEventListener('click', () => {
    const iframe = document.getElementById('previewIframe');
    try { iframe.contentWindow.postMessage({ type: 'RESET' }, '*'); }
    catch (e) { iframe.src = iframe.src; }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePreview();
  });
}

function openPreview(item) {
  const modal = document.getElementById('previewModal');
  document.getElementById('modalTitle').textContent = item.title;
  document.getElementById('modalDesc').textContent = item.description;
  document.getElementById('modalTags').innerHTML = (item.tags || []).map(t =>
    `<span class="tag is-primary is-light">${t}</span>`
  ).join('');
  document.getElementById('previewIframe').src = item.demoUrl;
  document.getElementById('modalOpenBtn').href = item.demoUrl;
  modal.classList.add('is-active');
  document.documentElement.classList.add('is-clipped');
}

function closePreview() {
  const modal = document.getElementById('previewModal');
  modal.classList.remove('is-active');
  document.documentElement.classList.remove('is-clipped');
  document.getElementById('previewIframe').src = 'about:blank';
}
</script>
</body>
</html>
